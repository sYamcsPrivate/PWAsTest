<!DOCTYPE html>
<html lang="jp">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, shrink-to-fit=no">
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" href="./icon.png">
<link rel="apple-touch-icon" href="./icon.png">
<title>PWAsTest - App3</title>
</head>
<body width="0px" height="0px" style="margin:0"></body>
<script defer src="./app.js"></script>
<script>
window.onload=()=>{
  app({hide: true, cache: true, pwa: true})
  //app({cache: true, pwa: true})
  //app({hide: true})
  //app({posx:-65, posy:-65})
  //app({posx:-65, posy:-65, hide: true})
  //app()

/*
  app({cache: true})
  app.log(app.getCacheItems())
  app.setCacheItems([
    "./icon.png",
    "./manifest.json",
    "./",
  ]);
  app.log(app.getCacheItems())
  app({pwa: true})
*/



  app.log("index.html: start")

  const cacheKey = "index.html.cache"

  let varCount = 0

  let cacheObj = {
    "count": varCount
  }

  
  document.body.insertAdjacentHTML("beforeend", String.raw`
    <style>
      #pos {
        font-family: 'M PLUS Rounded 1c', 游ゴシック体, 'Yu Gothic', YuGothic, 'ヒラギノ角ゴシック Pro', 'Hiragino Kaku Gothic Pro', メイリオ, Meiryo, Osaka, 'ＭＳ Ｐゴシック', 'MS PGothic', sans-serif;
        text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
        font-size: 7rem;
        position: fixed;
        top: 10%;
        left: 10%;
      }
      .area {
        width: 80vw;
        height: 40vh;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      #show {
        background: #66bbbb;
        transition: background-color 1s;
      }
      #show.flash{
        background: #99eeee;
        transition-duration: 0s;
      }
      #touch {
        background: #eeee66;
      }
      #touch img {
        width: 30%;
        min-width: 256px;
        height: auto;
      }

.purun {
  animation: purun 0.8s linear 0s 1;
}

@keyframes purun {
  0%   { transform: scale(1.0, 1.0) translate(0%, 0%); }
  15%  { transform: scale(0.9, 0.9) translate(0%, 5%); }
  30%  { transform: scale(1.3, 0.8) translate(0%, 10%); }
  50%  { transform: scale(0.8, 1.3) translate(0%, -10%); }
  70%  { transform: scale(1.1, 0.9) translate(0%, 5%); }
  100% { transform: scale(1.0, 1.0) translate(0%, 0%); }
}

.korokoro {
  animation: korokoro 2.5s linear 0s 1;
}

@keyframes korokoro {
  0%   { transform: translate(0%, 0%); }
  5%   { transform: translate(10%, 0%) rotate(10deg); }
  25%  { transform: translate(20%, 0%) rotate(20deg); }
  30%  { transform: translate(-10%, 0%) rotate(-10deg); }
  35%  { transform: translate(-15%, 0%) rotate(-15deg); }
  45%  { transform: translate(10%, 0%) rotate(10deg); }
  50%  { transform: translate(15%, 0%) rotate(15deg); }
  60%  { transform: translate(-5%, 0%) rotate(-5deg); }
  65%  { transform: translate(-7%, 0%) rotate(-7deg); }
  75%  { transform: translate(0%, 0%) rotate(0deg); }
  100% { transform: translate(0%, 0%) rotate(0deg); }
}

      .poyooon {
        animation: poyooon 0.9s linear 0s 1;
      }
      @keyframes poyooon {
        0%   { transform: scale(1.0, 1.0) translate(0%, 0%); }
        10%  { transform: scale(1.1, 0.9) translate(0%, 5%); }
        40%  { transform: scale(1.2, 0.8) translate(0%, 15%); }
        50%  { transform: scale(1.0, 1.0) translate(0%, 0%); }
        60%  { transform: scale(0.9, 1.2) translate(0%, -100%); }
        75%  { transform: scale(0.9, 1.2) translate(0%, -20%); }
        85%  { transform: scale(1.2, 0.8) translate(0%, 15%); }
        100% { transform: scale(1.0, 1.0) translate(0%, 0%); }
      }
    </style>
    <div id="pos">
      <div id="show" class="area">0</div>
      <div id="touch" class="area"><img src="./icon.png"></div>
    </div>
  `)

  const view=()=>{
    app.log("touch count: " + varCount)
    document.getElementById("show").innerHTML=varCount
    cacheObj.count = varCount
    app.sync(`setCache("${cacheKey}", ${JSON.stringify(cacheObj)})`)
  }

  const msaddclass=(q, c, ms)=>{
    const e = document.querySelector(q);
    e.classList.add(c);
    setTimeout(()=>{
      e.classList.remove(c);
    }, ms);
    return e
  }
  let isTimer = false
  document.getElementById("show").addEventListener("click",()=>{
    if (!isTimer && varCount > 0) {
      isTimer = true
      const timerid1 = setInterval(()=>{
        msaddclass("#touch img", "korokoro", 2500)
        if (varCount <= 0) {
          clearInterval(timerid1)
        }
      }, 2600);
      const timerid2 = setInterval(()=>{
        varCount = varCount - 1
        view()
        if (varCount <= 0) {
          document.querySelector("#touch img").classList.remove("korokoro");
          clearInterval(timerid1)
          clearInterval(timerid2)
          isTimer = false
          msaddclass("#show", "flash", 50)
          msaddclass("#touch img", "poyooon", 900)
        }
      }, 1000);
    }
  });

  document.getElementById("touch").addEventListener("click",()=>{
    if (!isTimer) {
      msaddclass("#touch img", "purun", 800)
      varCount = varCount + 1
      view()
    }
  });

  app.getCache(cacheKey).then(res=>{
    if (res !== undefined) {
      varCount = res.count
      view()
    }
  }).finally(()=>app.log(`${cacheKey}: getter end`))

  app.log("index.html: end")



}
</script>
</html>
