<!DOCTYPE html>
<html lang="jp">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, shrink-to-fit=no">
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" href="./image/icon.png">
<link rel="apple-touch-icon" href="./image/icon.png">
<title>PWAsTest - App3</title>
</head>
<body width="0px" height="0px" style="margin:0"></body>
<script defer src="./logger.js"></script>
<script>
window.onload=()=>{
  //logger()
  //logger({posx:-65, posy:-65, hide: true})
  //logger({posx:-65, posy:-65})
  //logger({hide: true})

  logger({sw: true, cdn: false, pos: "left-bottom"})

  //logger({cdn: false, hide: false, posx: 65, posy: -130})
  //logger({pos: "left-top", posx:-30, posy:-30})
  //logger({pos: "left-bottom", posx:-65, posy:65, hide:true})
  //logger({pos: "right-top", posx:65, posy:-65, hide:true})

/*
  logger.log(logger.getLocalItems())
  logger.setCacheItems([
    "./image/icon.png",
    "./manifest.json",
    "./",
  ]);
  logger.log(logger.getLocalItems())
  logger({sw: true})
*/



  logger.log("index.html: start")



  document.body.insertAdjacentHTML("beforeend", String.raw`
    <style>
      button:active {
        -webkit-transform: translate(1px, 1px);
        -moz-transform: translate(1px, 1px);
        transform: translate(1px, 1px);
      }
      .pos {
        font-family: 'M PLUS Rounded 1c', 游ゴシック体, 'Yu Gothic', YuGothic, 'ヒラギノ角ゴシック Pro', 'Hiragino Kaku Gothic Pro', メイリオ, Meiryo, Osaka, 'ＭＳ Ｐゴシック', 'MS PGothic', sans-serif;
        text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
        position: fixed;
        top: 5%;
        left: 5%;
      }
      .btns {
        width: 90vw;
        height: 6vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn {
        font-size: 1rem;
        color: #000000;
        width: 20vw;
        margin: 10px;
        box-shadow: 0 0 3px 0 rgb(0 0 0 / 12%), 0 2px 3px 0 rgb(0 0 0 / 22%);
        border-radius: 6px;
      }
      .area {
        font-size: 8rem;
        width: 90vw;
        height: 80vh;
        box-shadow: 0 0 3px 0 rgb(0 0 0 / 12%), 0 2px 3px 0 rgb(0 0 0 / 22%);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: #d0d0d0;
        transition: background-color 1.5s;
      }
      .flash {
        background: #dfefcf;
        transition-duration: 0s;
      }
    </style>
    <div class="pos">
      <div class="btns">
        <button id="settings" class="btn">settings</button>
        <button id="send" class="btn">send</button>
        <button id="recv" class="btn">recv</button>
        <button id="clear" class="btn">clear</button>
      </div>
      <div id="show" class="area">0</div>
    </div>
  `)



  let fConnect = false

  let recObj = {
    "localname": "index.html.rec", //must
    "count": 0
  }



  const view=()=>{
    logger.log("touch count: " + recObj.count)
    document.getElementById("show").innerHTML=recObj.count
    logger.setLocal(recObj) //ローカル記録の位置付け
  }

  const msaddclass=(q, c, ms)=>{
    const e = document.querySelector(q);
    e.classList.add(c);
    setTimeout(()=>{
      e.classList.remove(c);
    }, ms);
    return e
  }

  const sendPost=()=>{
    logger.log(`sendPost: start, recObj:${JSON.stringify(recObj)}`)
    document.getElementById("show").innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`
    logger.setPost(recObj).then(postname=>{
      logger.log("sendPost: success, postname: " + postname)
      recObj.postname=(recObj.postname)?recObj.postname:postname
    }).catch(err=>{
      logger.log("sendPost: catch(e): " + err)
    }).finally(()=>{
      logger.log(`sendPost: end, recObj:${JSON.stringify(recObj)}`)
      msaddclass("#show", "flash", 50)
      view()
      fConnect = false
    })
  }

  const recvPost=()=>{
    logger.log(`recvPost: start, recObj:${JSON.stringify(recObj)}`)
    document.getElementById("show").innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`
    logger.getPost(recObj).then(obj=>{
      logger.log("recvPost: success, obj.postname: " + obj.postname)
      recObj=(obj)?obj:recObj
    }).catch(err=>{
      logger.log("recvPost: catch(e): " + err)
    }).finally(()=>{
      logger.log(`recvPost: end, recObj:${JSON.stringify(recObj)}`)
      msaddclass("#show", "flash", 50)
      view()
      fConnect = false
    })
  }



  document.getElementById("settings").addEventListener("click",()=>{
    logger.log("settings click")
    let res = prompt("postname?", recObj.postname)
    recObj.postname=(res)?res:recObj.postname
    logger.log("postname: " + recObj.postname)
  })

  document.getElementById("send").addEventListener("click",()=>{
    logger.log("send click")
    if (fConnect) {
      logger.log("connection now, send fail")
    } else {
      fConnect = true
      sendPost()
    }
  })

  document.getElementById("recv").addEventListener("click",()=>{
    logger.log("recv click")
    if (fConnect) {
      logger.log("connection now, recv fail")
    } else {
      fConnect = true
      recvPost()
    }
  })

  document.getElementById("clear").addEventListener("click",()=>{
    logger.log("clear click")
    recObj.count = 0
    view()
    msaddclass("#show", "flash", 50)
  });

  document.getElementById("show").addEventListener("click",()=>{
    logger.log("show click")
    if (fConnect) {
      logger.log("connection now, count fail")
    } else {
      recObj.count = recObj.count + 1
      view()
    }
  });

  document.addEventListener("dblclick", e=>{
    logger.log("double click")
    e.preventDefault()
  }, {passive: false})



  const getLocal=()=>{
    logger.log(`getLocalPost: start`)
    document.getElementById("show").innerHTML=`<font size="2">loading...</font>`
    const res = logger.getLocal(recObj)
    if (res) recObj=res
    logger.log(`getLocal: end, recObj:${JSON.stringify(recObj)}`)
    msaddclass("#show", "flash", 50)
    view()
  }
  getLocal()



  logger.log("index.html: end")



}
</script>
</html>
