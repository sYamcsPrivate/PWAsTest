<!DOCTYPE html>
<html lang="jp">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, shrink-to-fit=no">
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" href="./icon.png">
<link rel="apple-touch-icon" href="./icon.png">
<title>PWAsTest - App3</title>
</head>
<body width="0px" height="0px" style="margin:0"></body>
<script defer src="./logger.js"></script>
<script>
window.onload=()=>{
  //logger({rec: "cache", pwa: true})
  //logger({hide: true, rec: "local", pwa: false})
  //logger({hide: true, rec: "local", pwa: true})
  //logger({rec: "local", pwa: true})
  //logger({hide: true})
  //logger({posx:-65, posy:-65})
  //logger({posx:-65, posy:-65, hide: true})
  //logger({rec: "cache"})
  //logger()
  logger({pwa: true})

/*
  logger({rec: "local"})
  logger.log(logger.getLocalItems())
  logger.setCacheItems([
    "./icon.png",
    "./manifest.json",
    "./",
  ]);
  logger.log(logger.getLocalItems())
  logger({pwa: true})
*/



  logger.log("index.html: start")

  document.body.insertAdjacentHTML("beforeend", String.raw`
    <style>
      #pos {
        font-family: 'M PLUS Rounded 1c', 游ゴシック体, 'Yu Gothic', YuGothic, 'ヒラギノ角ゴシック Pro', 'Hiragino Kaku Gothic Pro', メイリオ, Meiryo, Osaka, 'ＭＳ Ｐゴシック', 'MS PGothic', sans-serif;
        text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
        position: fixed;
        top: 10%;
        left: 10%;
      }
      .area {
        font-size: 7rem;
        width: 80vw;
        height: 40vh;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      #show {
        background: #66bbbb;
        transition: background-color 1s;
      }
      #show.flash{
        background: #99eeee;
        transition-duration: 0s;
      }
      #touch {
        background: #eeee66;
      }
      #touch img {
        width: 30%;
        min-width: 256px;
        height: auto;
      }

      .purun {
        animation: purun 0.8s linear 0s 1;
      }
      
      @keyframes purun {
        0%   { transform: scale(1.0, 1.0) translate(0%, 0%); }
        15%  { transform: scale(0.9, 0.9) translate(0%, 5%); }
        30%  { transform: scale(1.3, 0.8) translate(0%, 10%); }
        50%  { transform: scale(0.8, 1.3) translate(0%, -10%); }
        70%  { transform: scale(1.1, 0.9) translate(0%, 5%); }
        100% { transform: scale(1.0, 1.0) translate(0%, 0%); }
      }
      
      .korokoro {
        animation: korokoro 2.5s linear 0s 1;
      }
      
      @keyframes korokoro {
        0%   { transform: translate(0%, 0%); }
        5%   { transform: translate(10%, 0%) rotate(10deg); }
        25%  { transform: translate(20%, 0%) rotate(20deg); }
        30%  { transform: translate(-10%, 0%) rotate(-10deg); }
        35%  { transform: translate(-15%, 0%) rotate(-15deg); }
        45%  { transform: translate(10%, 0%) rotate(10deg); }
        50%  { transform: translate(15%, 0%) rotate(15deg); }
        60%  { transform: translate(-5%, 0%) rotate(-5deg); }
        65%  { transform: translate(-7%, 0%) rotate(-7deg); }
        75%  { transform: translate(0%, 0%) rotate(0deg); }
        100% { transform: translate(0%, 0%) rotate(0deg); }
      }

      .poyooon {
        animation: poyooon 0.9s linear 0s 1;
      }
      @keyframes poyooon {
        0%   { transform: scale(1.0, 1.0) translate(0%, 0%); }
        10%  { transform: scale(1.1, 0.9) translate(0%, 5%); }
        40%  { transform: scale(1.2, 0.8) translate(0%, 15%); }
        50%  { transform: scale(1.0, 1.0) translate(0%, 0%); }
        60%  { transform: scale(0.9, 1.2) translate(0%, -100%); }
        75%  { transform: scale(0.9, 1.2) translate(0%, -20%); }
        85%  { transform: scale(1.2, 0.8) translate(0%, 15%); }
        100% { transform: scale(1.0, 1.0) translate(0%, 0%); }
      }
    </style>
    <button id="settings">settings</button>
    <button id="recv">recv</button>
    <button id="send">send</button>
    <div id="pos">
      <div id=""></div>
      <div id="show" class="area">0</div>
      <div id="touch" class="area"><img src="./icon.png"></div>
    </div>
  `)

  const postURL  = "https://script.google.com/macros/s/AKfycbztpS68-LlWTOIcb-nF_rNwwBUY--M8x-J7O-Am_D8edkTUOndHAZ22oiyVwN36BB2_-Q/exec"
  const recKey = "index.html.rec"
  let recObj = {
    "count": 0
  }

  let isTimer = false

  const view=()=>{
    logger.log("touch count: " + recObj.count)
    document.getElementById("show").innerHTML=recObj.count
    logger.sync(`setLocal("${recKey}", ${JSON.stringify(recObj)})`) //ローカル記録の位置付け
  }

  const msaddclass=(q, c, ms)=>{
    const e = document.querySelector(q);
    e.classList.add(c);
    setTimeout(()=>{
      e.classList.remove(c);
    }, ms);
    return e
  }

  document.getElementById("settings").addEventListener("click",()=>{
    let res = prompt("name?", recObj.name)
    recObj.name=(res)?res:recObj.name
    logger.log("name: " + recObj.name)
  })

  let timerid1, timerid2
  document.getElementById("show").addEventListener("click",()=>{
    const stop=()=>{
      clearInterval(timerid1)
      clearInterval(timerid2)
      isTimer = false
      msaddclass("#show", "flash", 50)
      msaddclass("#touch img", "poyooon", 900)
    }
    if (recObj.count > 0) {
      if (isTimer) {
        stop()
      } else {
        msaddclass("#show", "flash", 50)
        sendPost() //サーバ記録の位置付け
        isTimer = true
        timerid1 = setInterval(()=>{
          msaddclass("#touch img", "korokoro", 2500)
          if (recObj.count <= 0) {
            clearInterval(timerid1)
          }
        }, 2600);
        timerid2 = setInterval(()=>{
          recObj.count = recObj.count - 1
          view()
          if (recObj.count <= 0) {
            document.querySelector("#touch img").classList.remove("korokoro");
            stop()
          }
        }, 1000);
      }
    }
  });

  document.getElementById("touch").addEventListener("click",()=>{
    if (!isTimer) {
      msaddclass("#touch img", "purun", 800)
      recObj.count = recObj.count + 1
      view()
    }
  });

  const recvPost=()=>{
    logger.log(`recvPost: start, recObj:${JSON.stringify(recObj)}`)
    logger.doPost(postURL, {
      "action": "get",
      "data": {
        "name": recObj.name,
      },
    }).then(res=>{
      recObj=(res)?res:recObj
    //}).catch(err=>alert("Failed to receive. please try again"))
    }).finally(()=>{
      logger.log(`recvPost:  end, recObj:${JSON.stringify(recObj)}`)
      msaddclass("#show", "flash", 50)
      view()
    })
  }

  const sendPost=()=>{
    logger.log(`sendPost: start, recObj:${JSON.stringify(recObj)}`)
    logger.doPost(postURL, {
      "action": "set",
      "data": recObj,
    }).then(res=>{
      recObj.name=(recObj.name)?recObj.name:res.name
    }).catch(err=>{
      alert("Failed to send. please try again")
    }).finally(()=>{
      logger.log(`sendPost: end, recObj:${JSON.stringify(recObj)}`)
    })
  }

  document.getElementById("recv").addEventListener("click",()=>recvPost())
  document.getElementById("send").addEventListener("click",()=>sendPost())

  const getLocal=()=>{
    logger.log(`getLocalPost: start`)
    document.getElementById("show").innerHTML=`<font size="2">loading...</font>`
    logger.getLocal(recKey).then(res=>{
      if (res) recObj=res
      logger.log(`getLocal: end, recObj:${JSON.stringify(recObj)}`)
      msaddclass("#show", "flash", 50)
      view()
    })
  }
  getLocal()

  logger.log("index.html: end")



}
</script>
</html>
