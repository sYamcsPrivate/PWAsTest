<!DOCTYPE html>
<html lang="jp">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, shrink-to-fit=no">
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" href="./icon.png">
<link rel="apple-touch-icon" href="./icon.png">
<title>PWAsTest - App3</title>
</head>
<body width="0px" height="0px" style="margin:0"></body>
<script defer src="./app.js"></script>
<script>
window.onload=()=>{
  app({hide: true, cache: true, pwa: true})
  //app({cache: true, pwa: true})
  //app({hide: true})
  //app({posx:-65, posy:-65})
  //app({posx:-65, posy:-65, hide: true})
  //app()

/*
  app({cache: true})
  app.log(app.getCacheItems())
  app.setCacheItems([
    "./icon.png",
    "./manifest.json",
    "./",
  ]);
  app.log(app.getCacheItems())
  app({pwa: true})
*/



  app.log("index.html: start")

  document.body.insertAdjacentHTML("beforeend", String.raw`
    <style>
      #pos {
        font-family: 'M PLUS Rounded 1c', 游ゴシック体, 'Yu Gothic', YuGothic, 'ヒラギノ角ゴシック Pro', 'Hiragino Kaku Gothic Pro', メイリオ, Meiryo, Osaka, 'ＭＳ Ｐゴシック', 'MS PGothic', sans-serif;
        text-size-adjust: 100%;
        -webkit-text-size-adjust: 100%;
        position: fixed;
        top: 10%;
        left: 10%;
      }
      .area {
        font-size: 7rem;
        width: 80vw;
        height: 40vh;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      #show {
        background: #66bbbb;
        transition: background-color 1s;
      }
      #show.flash{
        background: #99eeee;
        transition-duration: 0s;
      }
      #touch {
        background: #eeee66;
      }
      #touch img {
        width: 30%;
        min-width: 256px;
        height: auto;
      }

      .purun {
        animation: purun 0.8s linear 0s 1;
      }
      
      @keyframes purun {
        0%   { transform: scale(1.0, 1.0) translate(0%, 0%); }
        15%  { transform: scale(0.9, 0.9) translate(0%, 5%); }
        30%  { transform: scale(1.3, 0.8) translate(0%, 10%); }
        50%  { transform: scale(0.8, 1.3) translate(0%, -10%); }
        70%  { transform: scale(1.1, 0.9) translate(0%, 5%); }
        100% { transform: scale(1.0, 1.0) translate(0%, 0%); }
      }
      
      .korokoro {
        animation: korokoro 2.5s linear 0s 1;
      }
      
      @keyframes korokoro {
        0%   { transform: translate(0%, 0%); }
        5%   { transform: translate(10%, 0%) rotate(10deg); }
        25%  { transform: translate(20%, 0%) rotate(20deg); }
        30%  { transform: translate(-10%, 0%) rotate(-10deg); }
        35%  { transform: translate(-15%, 0%) rotate(-15deg); }
        45%  { transform: translate(10%, 0%) rotate(10deg); }
        50%  { transform: translate(15%, 0%) rotate(15deg); }
        60%  { transform: translate(-5%, 0%) rotate(-5deg); }
        65%  { transform: translate(-7%, 0%) rotate(-7deg); }
        75%  { transform: translate(0%, 0%) rotate(0deg); }
        100% { transform: translate(0%, 0%) rotate(0deg); }
      }

      .poyooon {
        animation: poyooon 0.9s linear 0s 1;
      }
      @keyframes poyooon {
        0%   { transform: scale(1.0, 1.0) translate(0%, 0%); }
        10%  { transform: scale(1.1, 0.9) translate(0%, 5%); }
        40%  { transform: scale(1.2, 0.8) translate(0%, 15%); }
        50%  { transform: scale(1.0, 1.0) translate(0%, 0%); }
        60%  { transform: scale(0.9, 1.2) translate(0%, -100%); }
        75%  { transform: scale(0.9, 1.2) translate(0%, -20%); }
        85%  { transform: scale(1.2, 0.8) translate(0%, 15%); }
        100% { transform: scale(1.0, 1.0) translate(0%, 0%); }
      }
    </style>
    <!-- <button id="send">send</button> -->
    <!-- <button id="recv">send</button> -->
    <button id="settings">settings</button>
    <div id="pos">
      <div id=""></div>
      <div id="show" class="area">0</div>
      <div id="touch" class="area"><img src="./icon.png"></div>
    </div>
  `)

  const postURL  = "https://script.google.com/macros/s/AKfycbztpS68-LlWTOIcb-nF_rNwwBUY--M8x-J7O-Am_D8edkTUOndHAZ22oiyVwN36BB2_-Q/exec"
  const cacheKey = "index.html.cache"
  let cacheObj = {
    "name": "user1",
    "count": 0
  }

  let isTimer = false

  const view=()=>{
    app.log("touch count: " + cacheObj.count)
    document.getElementById("show").innerHTML=cacheObj.count
    app.sync(`setCache("${cacheKey}", ${JSON.stringify(cacheObj)})`) //キャッシュ記録の位置付け
  }

  const msaddclass=(q, c, ms)=>{
    const e = document.querySelector(q);
    e.classList.add(c);
    setTimeout(()=>{
      e.classList.remove(c);
    }, ms);
    return e
  }

  document.getElementById("settings").addEventListener("click",()=>{
    let res = prompt("name?", cacheObj.name)
    cacheObj.name=(res)?res:cacheObj.name
    app.log("name: " + cacheObj.name)
  })

  document.getElementById("show").addEventListener("click",()=>{
    if (!isTimer && cacheObj.count > 0) {
      msaddclass("#show", "flash", 50)
      sendPost() //サーバ記録の位置付け
      isTimer = true
      const timerid1 = setInterval(()=>{
        msaddclass("#touch img", "korokoro", 2500)
        if (cacheObj.count <= 0) {
          clearInterval(timerid1)
        }
      }, 2600);
      const timerid2 = setInterval(()=>{
        cacheObj.count = cacheObj.count - 1
        view()
        if (cacheObj.count <= 0) {
          document.querySelector("#touch img").classList.remove("korokoro");
          clearInterval(timerid1)
          clearInterval(timerid2)
          isTimer = false
          msaddclass("#show", "flash", 50)
          msaddclass("#touch img", "poyooon", 900)
        }
      }, 1000);
    }
  });

  document.getElementById("touch").addEventListener("click",()=>{
    if (!isTimer) {
      msaddclass("#touch img", "purun", 800)
      cacheObj.count = cacheObj.count + 1
      view()
    }
  });

  //document.getElementById("send").addEventListener("click",()=>{
  const sendPost=()=>{
    app.log(`sendpost: start, cacheObj:${JSON.stringify(cacheObj)}`)
    const req = {
      "action": "set",
      "name": cacheObj.name,
      "data": cacheObj,
    }
    app.doPost(postURL, req).catch(err=>{
      alert("Failed to send. please try again")
    }).finally(()=>{
      app.log(`sendpost: end, cacheObj:${JSON.stringify(cacheObj)}`)
    })
  }

  const getCachePost=()=>{
    app.log(`getCachePost: start`)
    document.getElementById("show").innerHTML=`<font size="2">loading...</font>`
    app.getCache(cacheKey).then(res=>{
      if (res) {
        cacheObj=res
      } else {
        throw ""
      }
      app.log(`window.load.getCachePost: cache end, cacheObj:${JSON.stringify(cacheObj)}`)
      msaddclass("#show", "flash", 50)
      view()
    }).catch(()=>{
      app.doPost(postURL, {
        "action": "get",
        "name": cacheObj.name,
        //"data": {},
        "data": cacheObj,
      }).then(res=>{
        cacheObj=(res)?res:cacheObj
      //}).catch(err=>alert("Failed to recv. please try again"))
      }).finally(()=>{
        app.log(`window.load.getCachePost: post end, cacheObj:${JSON.stringify(cacheObj)}`)
        msaddclass("#show", "flash", 50)
        view()
      })
    })
  }
  getCachePost()

  app.log("index.html: end")



}
</script>
</html>
